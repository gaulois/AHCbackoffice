<h4 class="mt-4">Plans d'√âtage</h4>

<!-- Ajout d'un nouveau plan d'√©tage -->
<div class="mb-3">
    <label for="image" class="form-label">S√©lectionnez une image</label>
    <input type="file" id="image" name="image" class="form-control">
</div>
<div class="mb-3">
    <label for="name" class="form-label">Nom du Plan</label>
    <input type="text" id="name" name="name" class="form-control">
</div>
<div class="mb-3">
    <label for="description" class="form-label">Description</label>
    <textarea id="description" name="description" class="form-control" rows="3"></textarea>
</div>
<button type="submit" formaction="{{ url_for('add_floorplan', client_id=client['_id']) }}" class="btn btn-primary">
    Ajouter
</button>

<h5 class="mt-5">Plans d'√âtage Existants</h5>
<ul class="list-group">
    {% for plan in floorplans %}
    <li class="list-group-item">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div class="me-3">
                <strong>Nom :</strong> {{ plan.name }} <br>
                <strong>Description :</strong> {{ plan.description }} <br>
                <strong>Date ajout√©e :</strong> {{ plan.uploadDate if plan.uploadDate else "Non sp√©cifi√©e" }}
            </div>

            <!-- Boutons d'action contextuels (√† droite du titre) -->
            {% if plan.imageUrl %}
                <div class="mt-2">
                   {% if plan.fileName.endswith('.docx') or plan.fileName.endswith('.doc') %}
  <!-- Ouvrir dans OnlyOffice -->
  <a href="{{ url_for('onlyoffice.view_doc', file_url=plan.imageUrl, file_name=plan.fileName) }}"
     target="_blank" class="btn btn-info me-2 mb-2">
    üìù Ouvrir dans OnlyOffice
  </a>

  <!-- T√©l√©charger (presign√© c√¥t√© serveur) -->
  <a href="{{ url_for('downloads.download_floorplan', key=plan.imagePath, name=plan.fileName) }}"
     class="btn btn-outline-secondary mb-2">
    ‚¨áÔ∏è T√©l√©charger
  </a>
{% elif plan.fileName.endswith('.pdf') %}
  <!-- Voir PDF dans le navigateur -->
  <a href="{{ plan.imageUrl }}" target="_blank" class="btn btn-outline-primary mb-2">
    üëÅÔ∏è Voir
  </a>
{% endif %}
                </div>
            {% endif %}
        </div>

        <!-- üìå Affichage du plan d'√©tage -->
        <div style="position: relative; display: block; width: 100%;">
            {% if plan.imageUrl %}
                {% if plan.fileName.endswith('.pdf') %}
                    <!-- üìÑ PDF en grand format -->
                    <iframe
                        src="{{ plan.imageUrl }}#zoom=page-width"
                        style="width: 100%; height: 80vh; border: 1px solid #ccc; border-radius: 6px;"
                        loading="lazy">
                    </iframe>

                {% elif plan.fileName.endswith('.png') or plan.fileName.endswith('.jpg') or plan.fileName.endswith('.jpeg') %}
                    <!-- üñºÔ∏è Image + canevas -->
                    <img src="{{ plan.imageUrl }}" alt="{{ plan.name }}" id="plan-image-{{ plan._id }}"
                         class="img-fluid" style="max-width: 100%; height: auto;">
                    <canvas id="canvas-{{ plan._id }}" style="position: absolute; top: 0; left: 0;"></canvas>

                {% elif plan.fileName.endswith('.docx') or plan.fileName.endswith('.doc') %}
                    <!-- Pour Word, on n‚Äôint√®gre pas l‚Äôaper√ßu ici : boutons ci-dessus -->
                    <p class="text-muted mt-2"><em>Document Word ‚Äî utilisez les boutons ci-dessus.</em></p>

                {% else %}
                    <p class="text-muted mt-2">Type de fichier non pris en charge pour l‚Äôaper√ßu.</p>
                {% endif %}
            {% else %}
                <p class="text-danger mt-2">‚ö†Ô∏è Fichier non disponible</p>
            {% endif %}
        </div>

        <!-- üìç Liste des pi√®ges associ√©s -->
        <h6 class="mt-4">Pi√®ges associ√©s</h6>
        <ul class="list-group">
            {% for trap in plan.traps %}
            <li class="list-group-item">
                <strong>Type :</strong> {{ trap.type | default("Non sp√©cifi√©") }} <br>
                <strong>Libell√© :</strong> {{ trap.label | default("Non sp√©cifi√©") }} <br>
                <strong>Emplacement :</strong> {{ trap.location | default("Non sp√©cifi√©") }} <br>
                {% if trap.coordinates %}
                <strong>Coordonn√©es :</strong> ({{ trap.coordinates.x | default("N/A") }}, {{ trap.coordinates.y | default("N/A") }}) <br>
                {% else %}
                <span class="text-danger">‚õî Aucune position d√©finie</span>
                {% endif %}
                <strong>Code-barre :</strong> {{ trap.barcode | default("Non sp√©cifi√©") }}
            </li>
            {% endfor %}
            {% if not plan.traps %}
            <li class="list-group-item text-muted">Aucun pi√®ge ajout√©.</li>
            {% endif %}
        </ul>
    </li>
    {% endfor %}
    {% if not floorplans %}
    <li class="list-group-item text-muted">Aucun plan d'√©tage trouv√©.</li>
    {% endif %}
</ul>