<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>G√©rer les pi√®ges - {{ plan.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #trapCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* Emp√™che le canevas d'interf√©rer avec l'image */
        }
        .canvas-container {
            position: relative;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>G√©rer l'emplacement des pi√®ges</h2>
        <p><strong>Plan :</strong> {{ plan.name }}</p>

        <!-- Affichage du plan d‚Äô√©tage avec un canevas pour placer les pi√®ges -->
        <div class="canvas-container">
            {% if plan.imageUrl %}
                <img src="{{ plan.imageUrl }}" alt="{{ plan.name }}" id="plan-image" class="img-fluid">
            {% else %}
                <p class="text-danger">Image introuvable {{ plan.imageUrl }}</p>
            {% endif %}
            <canvas id="trapCanvas"></canvas>
        </div>

        <!-- S√©lection d'un pi√®ge √† placer -->
        <h4 class="mt-4">S√©lectionner un pi√®ge</h4>
        <select id="trapSelect" class="form-select">
            <option value="" disabled selected>Choisissez un pi√®ge</option>
            {% for trap in traps %}
                <option value="{{ trap._id }}"
                        data-coord-x="{{ trap.coordinates.x if trap.coordinates else '' }}"
                        data-coord-y="{{ trap.coordinates.y if trap.coordinates else '' }}">
                    {{ trap.label }}
                </option>
            {% endfor %}
        </select>

        <!-- Coordonn√©es X et Y -->
        <div class="mt-3">
            <label>Coordonn√©e X:</label>
            <input type="text" id="coordX" class="form-control" >
            <label>Coordonn√©e Y:</label>
            <input type="text" id="coordY" class="form-control" >
        </div>

        <!-- Bouton pour sauvegarder les coordonn√©es -->
        <button id="saveTrapPosition" class="btn btn-primary mt-3" disabled>Sauvegarder l'emplacement</button>

        <!-- Liste des pi√®ges plac√©s -->
        <h4 class="mt-4">Pi√®ges existants</h4>
        <ul class="list-group" id="trapList">
            {% for trap in traps %}
            <li class="list-group-item">
                <strong>Type :</strong> {{ trap.type }} <br>
                <strong>Coordonn√©es :</strong>
                {% if trap.coordinates %}
                    ({{ trap.coordinates.x | default("N/A") }},
                    {{ trap.coordinates.y | default("N/A") }})
                {% else %}
                    <span class="text-danger">Non positionn√©</span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>

        <!-- Bouton retour -->
        <a href="{{ url_for('edit_client_route', client_id=plan.clientId) }}" class="btn btn-secondary mt-3">Retour</a>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const canvas = document.getElementById("trapCanvas");
        const ctx = canvas.getContext("2d");
        const planImage = document.getElementById("plan-image");
        const trapSelect = document.getElementById("trapSelect");
        const saveButton = document.getElementById("saveTrapPosition");
        const coordX = document.getElementById("coordX");
        const coordY = document.getElementById("coordY");

        let selectedTrapId = null;
        let trapCoordinates = { x: null, y: null };

        // Ajuster la taille du canevas apr√®s chargement de l'image
        planImage.onload = function () {
            canvas.width = planImage.clientWidth;
            canvas.height = planImage.clientHeight;
            drawTraps();
        };

        // üéØ **S√©lectionner un pi√®ge et afficher ses coordonn√©es**
        trapSelect.addEventListener("change", function () {
            const selectedOption = trapSelect.options[trapSelect.selectedIndex];
            selectedTrapId = selectedOption.value;
            saveButton.disabled = false;

            // R√©cup√©rer les coordonn√©es depuis les attributs data-coord-x et data-coord-y
            coordX.value = selectedOption.getAttribute("data-coord-x") || '';
            coordY.value = selectedOption.getAttribute("data-coord-y") || '';

            console.log(`Pi√®ge s√©lectionn√© : ${selectedOption.textContent}`);
            console.log(`Coordonn√©es r√©cup√©r√©es : X=${coordX.value}, Y=${coordY.value}`);
        });

        // üìç **Mettre √† jour les coordonn√©es lorsqu'on clique sur l'image**
        planImage.addEventListener("click", function (event) {
            if (!selectedTrapId) {
                alert("Veuillez s√©lectionner un pi√®ge avant de le placer.");
                return;
            }

            const rect = planImage.getBoundingClientRect();
            trapCoordinates.x = Math.floor(event.clientX - rect.left);
            trapCoordinates.y = Math.floor(event.clientY - rect.top);

            console.log(`Pi√®ge d√©plac√© : (${trapCoordinates.x}, ${trapCoordinates.y})`);

            // Mettre √† jour les champs X et Y
            coordX.value = trapCoordinates.x;
            coordY.value = trapCoordinates.y;
             updateTrapPosition(selectedTrapId, trapCoordinates.x, trapCoordinates.y);
        });

        // üíæ **Sauvegarder les coordonn√©es**
        saveButton.addEventListener("click", function () {
            console.log("Bouton 'Sauvegarder l'emplacement' cliqu√© !");

            const x = parseInt(coordX.value);
            const y = parseInt(coordY.value);

            if (!selectedTrapId) {
                alert("Veuillez s√©lectionner un pi√®ge.");
                return;
            }

            console.log(`ID du pi√®ge s√©lectionn√© : ${selectedTrapId}`);
            console.log(`Coordonn√©es enregistr√©es : X=${x}, Y=${y}`);

            // Envoyer la requ√™te √† Flask pour sauvegarder les coordonn√©es
            fetch("{{ url_for('save_trap_position') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ trap_id: selectedTrapId, x: x, y: y }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("Coordonn√©es sauvegard√©es !");
                    alert("Les coordonn√©es ont √©t√© mises √† jour !");

                    // Mettre √† jour les donn√©es du pi√®ge dans la page
                    updateTrapCoordinates(selectedTrapId, x, y);
                    location.reload();
                    // Redessiner les pi√®ges sans recharger la page
                    drawTraps();
                } else {
                    alert("Erreur lors de la sauvegarde.");
                }
            })
            .catch(error => {
                console.error("Erreur :", error);
                alert("Erreur lors de la sauvegarde.");
            });
        });

        // üìå **Met √† jour les coordonn√©es dans la liste des pi√®ges**
        function updateTrapCoordinates(trapId, x, y) {
            const trapOption = trapSelect.querySelector(`option[value="${trapId}"]`);
            if (trapOption) {
                trapOption.setAttribute("data-coord-x", x);
                trapOption.setAttribute("data-coord-y", y);
            }
        }
  // üé® **Mettre √† jour la position du pi√®ge s√©lectionn√© (visuellement uniquement)**
    function updateTrapPosition(trapId, x, y) {
        console.log(`üîÑ Mise √† jour de la position du pi√®ge ${trapId} √† (${x}, ${y})`);

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawTraps(); // Redessiner les pi√®ges existants

        // Dessiner le pi√®ge d√©plac√© en bleu (temporaire)
        ctx.fillStyle = "blue";
        ctx.beginPath();
        ctx.arc(x, y, 10, 0, Math.PI * 2);
        ctx.fill();
        ctx.closePath();
    }
        // üñåÔ∏è **Redessiner les pi√®ges**
        function drawTraps() {
        console.log("Redessiner les pi√®ges**!");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            {% for trap in traps %}
                {% if trap.coordinates %}
                    ctx.fillStyle = "red";
                    ctx.beginPath();
                    ctx.arc({{ trap.coordinates.x }}, {{ trap.coordinates.y }}, 10, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.closePath();
                    ctx.font = "12px Arial";
                    ctx.fillText("{{ trap.label }}", {{ trap.coordinates.x + 12 }}, {{ trap.coordinates.y + 4 }});
                {% endif %}
            {% endfor %}
        }
    });
</script>
</body>
</html>